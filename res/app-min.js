const{createApp:createApp}=Vue;class Beyblade{constructor(){this.init()}init(){this.is_cx=!1,this.cx_chip=new CxLockChip,this.cx_main=new Blade,this.cx_assist=new CxAssistBlade,this.blade=new Blade,this.ratchet=new Ratchet,this.bit=new Bit}assign(e){this.is_cx=e.is_cx,this.cx_chip.assign(e.cx_chip),this.cx_main.assign(e.cx_main),this.cx_assist.assign(e.cx_assist),this.blade.assign(e.blade),this.ratchet.assign(e.ratchet),this.bit.assign(e.bit)}clone(){let e=new Beyblade;return e.assign(this),e}blade_name(e=!1){return this.is_cx?this.cx_chip.name(e)+this.cx_main.name(e)+" "+this.cx_assist.symbol:this.blade.name(e)}ratchet_name(){return this.ratchet.name}bit_name(){return this.bit.symbol}name(e=!1){return this.blade_name(e)+" "+this.ratchet.name+" "+this.bit.symbol}serialize(){return{series:this.is_cx?this.cx_main.series:this.blade.series,blade:this.is_cx?{chip:this.cx_chip.serialize(),main:this.cx_main.serialize(),assist:this.cx_assist.serialize()}:this.blade.serialize(),ratchet:this.ratchet.serialize(),bit:this.bit.serialize()}}deserialize(e){this.is_cx=e.series===BLADE_SERIES_CX,this.ratchet.deserialize(e.ratchet),this.bit.deserialize(e.bit);const t=e.blade;this.is_cx?(this.cx_chip.deserialize(t.chip),this.cx_main.deserialize(!0,t.main),this.cx_assist.deserialize(t.assist)):this.blade.deserialize(!1,t)}}class Entry{constructor(e=-1,t=!1){this.id=e,this.number=t?e+1:"",this.name=""}assign(e){this.id=e.id,this.number=e.number,this.name=e.name}get_matches(e){const t=[];if(this.id>=0&&e.length>0)for(let s=e[0].matches[this.id>>1];null!==s&&(s.is_finished()&&s.is_player(this.id));s=s.next)t.push(s);return t}next_match(e){if(e.length>0)for(let t=e[0].matches[this.id>>1];null!==t;t=t.next){if(t.is_finished()){if(t.is_winner(this.id))continue;return[null,null]}return[t,t.next]}return[null,null]}serialize(){return this}deserialize(e){this.assign(e)}}class Side{constructor(e=POSITION_LEFT,t=new Entry){this.pos=e,this.entry=t,this.bey=new Beyblade}get is_left(){return this.pos===POSITION_LEFT}set is_left(e){this.pos=e?POSITION_LEFT:POSITION_RIGHT}is_active(){return this.entry.id>=0}id(){return this.entry.id}name(){return this.entry.name}number(){return this.entry.number}beyblade(){return this.bey}position(){return POSITION_NAME[this.pos]}init(e){this.pos=e,this.entry=new Entry,this.bey.init()}serialize(){return{entry:this.entry.id,position:this.position(),bey:this.bey.serialize()}}deserialize(e,t){t.entry<0?(this.bey=new Beyblade,this.entry=new Entry):(this.bey.deserialize(t.bey),this.entry=e[t.entry]),this.pos="L"===t.position?POSITION_LEFT:POSITION_RIGHT}}class Battle{constructor(e){this._match=e,this._finish_code=0}get f_code(){return this._finish_code}set f_code(e){this._finish_code=e,this._match.update_score()}finish(){return FINISH_NAME[15&this._finish_code]}result(){return[this._finish_code>>4,FINISH_POINT[15&this._finish_code]]}clear(){this._finish_code=0}serialize(){return this._finish_code.toString(16)}deserialize(e){this._finish_code=parseInt(e,16)}}class Match{constructor(e,t){this._id=e<<8|t,this.sides=[new Side(POSITION_LEFT),new Side(POSITION_RIGHT)],this.prev=[null,null],this.next=null,this.score=[0,0],this.battles=[new Battle(this),new Battle(this)],this.winner=null}get id(){return this._id}get round(){return this._id>>8}get order(){return 1+(255&this._id)}get side1(){return this.sides[SIDE_1]}get side2(){return this.sides[SIDE_2]}get score1(){return this.score[SIDE_1]}get score2(){return this.score[SIDE_2]}serialize(){return{round:this._id>>8,side1:this.sides[SIDE_1].serialize(),side2:this.sides[SIDE_2].serialize(),score1:this.score[SIDE_1],score2:this.score[SIDE_2],results:this.battles.map((e=>e.serialize()))}}deserialize(e,t){this.sides[SIDE_1].deserialize(e,t.side1),this.sides[SIDE_2].deserialize(e,t.side2),this.score[SIDE_1]=t.score1,this.score[SIDE_2]=t.score2,this.battles=t.results.map((e=>{let t=new Battle(this);return t.deserialize(e),t})),this.update_score()}update_score(){this.winner=null,this.score[SIDE_1]=this.score[SIDE_2]=0;for(let e of this.battles){let[t,s]=e.result();s>0&&(this.score[t]+=s)}this.score[SIDE_1]>=4?this.winner=this.sides[SIDE_1]:this.score[SIDE_2]>=4&&(this.winner=this.sides[SIDE_2]);const e=1&this.id;this.next&&(this.winner?this.next.set_entry(e,this.winner.entry,e):this.next.remove_entry(e))}finishes(e){return this.battles.filter((t=>t.f_code>>4===e)).map((e=>e.finish()))}finishes1(){return this.finishes(SIDE_1)}finishes2(){return this.finishes(SIDE_2)}get_target_sides(e){const t={side:this.sides[SIDE_1],finishes:this.finishes(SIDE_1),score:this.score[SIDE_1]},s={side:this.sides[SIDE_2],finishes:this.finishes(SIDE_2),score:this.score[SIDE_2]};switch(e){case this.sides[SIDE_1].id():return[t,s];case this.sides[SIDE_2].id():return[s,t]}return null}get_target_position(e){switch(e){case this.sides[0].id():return this.sides[0].position();case this.sides[1].id():return this.sides[1].position()}return""}set_entry(e,t,s){this.sides[e]=new Side(s,t)}remove_entry(e){this.sides[e].init(e)}is_player(e){return this.side1.id()===e||this.side2.id()===e}get_side_index(e){return this.side1.id()===e?0:this.side2.id()===e?1:-1}is_winner(e){return!!this.winner&&this.winner.id()===e}battle_addable(){return null===this.winner&&0!==this.last_battle().f_code}add_new_battle(){this.battles.push(new Battle(this))}remove_last_battle(){this.battles.pop(),this.update_score()}clear_battle(e){this.battles[e].clear(),this.update_score()}clear_battles(){this.battles=[],this.update_score()}last_battle(){return this.battles[this.battles.length-1]}is_loser(e){return null!=this.winner&&this.winner.entry.number!=e.number}is_finished(){return null!==this.winner}condition(){return this.winner?this.score1>this.score2?10:20:this.side1.is_active()&&this.side2.is_active()?1:this.side1.is_active()||this.side2.is_active()?0:-1}is_next_match(e,t){const s=e.find((e=>e.match===this.id));if(void 0!==s)return"1"+(s.side1?"1":"0")+(s.side2?"1":"0");const i=t.find((e=>e.match===this.id));return void 0!==i?"2"+(i.side1?"1":"0")+(i.side2?"1":"0"):"000"}}class Round{constructor(e,t){if(this.round=e,this.matches=null,t>0){this.matches=new Array(t);for(let e=0;e<this.matches.length;++e)this.matches[e]=new Match(this.round,e)}}match(e){return this.matches[e]}}function update_list_used(e,t){if(!e.is_empty()){const s=t.find((({item:t})=>t.symbol===e.symbol));s?s.count+=1:t.push({item:e.clone(),count:1}),t.sort(((e,t)=>e.count<t.count?1:-1))}}const app=Vue.createApp({data:()=>({is_eng:!1,date:(new Date).toLocaleDateString("sv-SE"),title:"",entries:[],rounds:[],my_number:0,my_entry:null,my_next1_match:null,my_next2_match:null,target_matches1:[],target_matches2:[],cur_match:new Match(0,0),cur_side:new Side,cur_entry:new Entry,cur_bey:new Beyblade,ifilename:"",key_in_storage:"",key_list:[],opt_rounds:ROUND_CHOICE,menu_visible:!1,page_beyed:1,types:TYPES,bit_list:BIT_LIST,bit_all:!0,bit_type:TYPE_ALL.value,bits_used:[],rat_list:RATCHET_LIST,rat_formats:RATCHET_FORMATS,rat_heights:RATCHET_HEIGHTS,rat_shapes:RATCHET_SHAPES,rat_all:!0,rat_format:RATCHET_FORMAT_ALL.value,rat_shape:RATCHET_SHAPE_ALL.value,rat_height:RATCHET_HEIGHT_ALL.value,rats_used:[],blade_all:!0,blade_type:TYPE_ALL.value,blade_categ:BLADE_ALL.value,blade_categs:BLADE_CATEGS,bxux_blade_list:BXUX_BLADE_LIST,bxux_blade_used:[],cx_main_list:CX_BLADE_LIST,cx_assists:CX_ASSIST,cx_chips:CX_CHIP,cx_main_used:[],cx_assist_used:[],cx_chip_used:[]}),created(){},computed:{},methods:{disable_scroll(e){e?document.getElementById("body").classList.add("no-scroll"):document.getElementById("body").classList.remove("no-scroll")},on_menu(){this.disable_scroll(this.menu_visible)},close_menu(){this.disable_scroll(this.menu_visible=!1)},set_my_entry(){if(this.target_matches1=[],this.target_matches2=[],0!==this.my_number){this.my_next1_match=null,this.my_next2_match=null,this.my_number>this.entries.length&&(this.my_number=this.entries.length);for(const e of this.entries)if(e.number===this.my_number){this.my_entry=e,[this.my_next1_match,this.my_next2_match]=e.next_match(this.rounds);break}this.analyze_next_match(this.target_matches1,this.my_next1_match),this.analyze_next_match(this.target_matches2,this.my_next2_match)}},analyze_next_match(e,t){if(!t)return;const s=t.get_side_index(this.my_entry.id);if(s>=0)return 1===t.condition()&&e.push({side1:0!==s,side2:1!==s,match:t.id}),void this.analyze_next_match(e,t.prev[1^s]);if(t.is_finished()){const s=t.condition()/20|0;return e.push({side1:0===s,side2:1===s,match:t.id}),void this.analyze_next_match(e,t.prev[s])}1===t.condition()&&e.push({side1:!0,side2:!0,match:t.id});for(const s of t.prev)this.analyze_next_match(e,s)},create_entries(e,t=!0){this.entries=new Array(e);for(let s=0;s<e;++s)this.entries[s]=new Entry(s,t)},create_tournament(e){const t=2**e;this.rounds=new Array(e),this.rounds[e-1]=new Round(e,1);for(let e=this.rounds.length-2;e>=0;--e){const s=t>>e+1,i=new Round(e+1,s),n=this.rounds[e+1];for(let e=0;e<s;++e)i.match(e).next=n.match(e>>1),n.match(e>>1).prev[1&e]=i.match(e);this.rounds[e]=i}const s=this.rounds[0];for(let e=0;e<this.entries.length;e+=2){const t=s.match(e>>1);t.set_entry(SIDE_1,this.entries[e],POSITION_LEFT),t.set_entry(SIDE_2,this.entries[e+1],POSITION_RIGHT)}this.set_my_entry()},export_json(e){const t=new Array(this.entries.length-1);let s=0;for(const e of this.rounds)for(const i of e.matches)t[s++]=i.serialize();return JSON.stringify({version:FILE_VERSION,date:this.date,title:this.title,rounds:this.rounds.length,entries:this.entries.map((e=>e.serialize())),matches:t},null,e)},import_json(e){const t=JSON.parse(e);if(FILE_VERSION!==t.version)return void alert("JSON file version does not match!");this.date=t.date,this.title=t.title,this.entries=t.entries.map((e=>{const t=new Entry;return t.deserialize(e),t}));const s=t.rounds;this.create_tournament(s);let i=0;for(const e of this.rounds)for(const s of e.matches)s.deserialize(this.entries,t.matches[i++])},remove_storage(){localStorage.removeItem(this.key_in_storage),this.key_list=Object.keys(localStorage)},clear_storage(){localStorage.clear()},open_dlg_new(){this.menu_visible=!1,this.disable_scroll(!0),document.getElementById("dlg_new").showModal()},close_dlg_new(e){if(this.disable_scroll(!1),document.getElementById("dlg_new").close(),e){const e=document.getElementById("num_rounds").value;this.create_entries(1<<e,e,document.getElementById("seq_num").checked),this.create_tournament(e)}},open_dlg_import(){this.menu_visible=!1,this.disable_scroll(!0),document.getElementById("dlg_import").showModal()},close_dlg_import(e){if(this.disable_scroll(!1),document.getElementById("dlg_import").close(),e){const e=new FileReader,t=this;e.onload=async function(){t.import_json(e.result)},e.readAsText(this.ifilename)}},set_ifile(e){this.ifilename=e.target.files[0]},open_dlg_export(){this.menu_visible=!1,this.disable_scroll(!0),document.getElementById("dlg_export").showModal()},close_dlg_export(e){if(this.disable_scroll(!1),document.getElementById("dlg_export").close(),e){const e=new Blob([this.export_json("  ")],{type:"application/json"}),t=document.createElement("a");t.href=URL.createObjectURL(e),t.download="tournament.json",t.click(),t.remove()}},open_dlg_load(){this.menu_visible=!1,this.disable_scroll(!0),this.key_list=Object.keys(localStorage),document.getElementById("dlg_load").showModal()},close_dlg_load(e){this.disable_scroll(!1),document.getElementById("dlg_load").close(),e&&this.import_json(localStorage.getItem(this.key_in_storage))},open_dlg_save(){this.menu_visible=!1,this.disable_scroll(!0),document.getElementById("dlg_save").showModal()},close_dlg_save(e){this.disable_scroll(!1),document.getElementById("dlg_save").close(),e&&localStorage.setItem(this.key_in_storage,this.export_json())},open_dlg_remove(){this.menu_visible=!1,this.disable_scroll(!0),this.key_list=Object.keys(localStorage),document.getElementById("dlg_remove").showModal()},close_dlg_remove(){this.disable_scroll(!1),document.getElementById("dlg_remove").close()},open_dlg_history(e){this.disable_scroll(!0),e.is_active()&&(this.cur_entry=e.entry,document.getElementById("dlg_history").showModal())},close_dlg_history(){this.disable_scroll(!1),document.getElementById("dlg_history").close()},open_dlg_match(e){this.cur_match=e,this.disable_scroll(!0),document.getElementById("dlg_match").showModal()},close_dlg_match(){this.disable_scroll(!1),document.getElementById("dlg_match").close()},update_finish_buttons(e){e<=2||e<this.cur_match.battles.length?this.cur_match.clear_battle(e-1):e==this.cur_match.battles.length+1?this.cur_match.battle_addable()&&this.cur_match.add_new_battle():e==this.cur_match.battles.length&&this.cur_match.remove_last_battle()},swap_position(){const e=this.cur_match.side1.pos;this.cur_match.side1.pos=this.cur_match.side2.pos,this.cur_match.side2.pos=e},open_dlg_beyed(e){this.cur_side=e,this.cur_bey=e.bey.clone(),this.disable_scroll(!0),document.getElementById("dlg_beyed").showModal()},close_dlg_beyed(){this.disable_scroll(!1),this.cur_bey.is_cx?(update_list_used(this.cur_bey.cx_main,this.cx_main_used),update_list_used(this.cur_bey.cx_assist,this.cx_assist_used),update_list_used(this.cur_bey.cx_chip,this.cx_chip_used)):update_list_used(this.cur_bey.blade,this.bxux_blade_used),update_list_used(this.cur_bey.ratchet,this.rats_used),update_list_used(this.cur_bey.bit,this.bits_used),this.cur_side.bey.assign(this.cur_bey),document.getElementById("dlg_beyed").close()},clear_bey(){this.cur_bey.init()},show_page_beyed(e){this.page_beyed=e},css_class_tab_beyed(e){if(this.page_beyed===e)switch(e){case 1:return"tab-blade";case 2:return"tab-ratchet";case 3:return"tab-bit"}return"tab-hidden"}}});app.mount("#app");